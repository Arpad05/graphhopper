name: Build and Test

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 21 ]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js (version compatible)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Clean NPM cache
        run: npm cache clean --force || true

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('web-bundle/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Build Web Bundle manually
        working-directory: web-bundle
        run: |
          npm install
          npm run build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin

      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven (tests normaux)
        run: mvn -B clean test

      - name: Verify current mutation score
        if: ${{ matrix.java-version == '21' }}
        run: mvn -B org.pitest:pitest-maven:mutationCoverage

      - name: Save report Pitest
        if: ${{ matrix.java-version == '21' }}
        run: |
          mkdir -p $GITHUB_WORKSPACE/pitest-reports
          cp -r target/pit-reports/* $GITHUB_WORKSPACE/pitest-reports/

      - name: Verify last commit mutation score
        if: ${{ matrix.java-version == '21' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.before }}
          path: prev
          fetch-depth: 0

      - name: Run Pitest on previous commit
        if: ${{ matrix.java-version == '21' }}
        run: |
          cd prev
          mvn -B org.pitest:pitest-maven:mutationCoverage

      - name: Compare mutation scores
        if: ${{ matrix.java-version == '21' }}
        run: |
          PREV_SCORE=$(grep 'Mutation Score:' prev/target/pit-reports/index.html | sed -E 's/.*Mutation Score:\s*([0-9]+).*/\1/')
          CURR_SCORE=$(grep 'Mutation Score:' pitest-reports/index.html | sed -E 's/.*Mutation Score:\s*([0-9]+).*/\1/')
          echo "Previous Mutation Score: $PREV_SCORE"
          echo "Current Mutation Score: $CURR_SCORE"
          if [ "$CURR_SCORE" -lt "$PREV_SCORE" ]; then
            echo "Mutation score decreased from $PREV_SCORE to $CURR_SCORE"
            exit 1
          else
            echo "Mutation score did not decrease."
          fi

  rickroll:
    needs: build
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Rickroll on failure
        run: |
          echo "Le score de mutation a baiss√© !!"
          echo "Never gonna give you up"
          echo "Never gonna let you down"
          echo "Never gonna fail the tests and desert you"
          echo "Never gonna make you cry"
          echo "Never gonna say 'Good try'"
          echo "Never gonna tell a lie and compile for you"
