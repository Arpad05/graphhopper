name: Build and Test

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 21 ]
        

    steps:
      - uses: actions/checkout@v4
      - name: Build all modules
        run: mvn -B clean install -DskipTests
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin

      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven (tests normaux)
        run: mvn -B clean test

      - name: Verify current mutation score
        run: |
          mvn -B clean install -DskipTests
          mvn -B org.pitest:pitest-maven:mutationCoverage || true
      - name: Save reports from all modules
        run: |
          mkdir -p $GITHUB_WORKSPACE/pitest-reports
          found=0
          for dir in $(find . -type d -path "*/target/pit-reports"); do
            echo "Copie depuis $dir"
            cp -r "$dir"/* $GITHUB_WORKSPACE/pitest-reports/ || true
            found=1
          done
          if [ $found -eq 0 ]; then
            echo "Aucun rapport Pitest trouvé — vérifier la configuration du plugin."
          else
            echo "Rapports Pitest sauvegardés."
          fi

      - name: Verify last commit mutation score
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.before }}
          path: prev
          fetch-depth: 0

      - name: Run Pitest on previous commit
        run: |
          cd prev
          mvn -B -P mutation org.pitest:pitest-maven:mutationCoverage || true
          mkdir -p $GITHUB_WORKSPACE/prev-reports
          for dir in $(find . -type d -path "*/target/pit-reports"); do
            echo "Copie depuis $dir"
            cp -r "$dir"/* $GITHUB_WORKSPACE/prev-reports/ || true
          done

      - name: Compare mutation scores
        run: |
          PREV_SCORE=$(find prev-reports -type f -name "index.html" -exec grep -oP "(?<=Mutation Score: )\d+" {} \; | head -1 || echo 0)
          CURR_SCORE=$(find pitest-reports -type f -name "index.html" -exec grep -oP "(?<=Mutation Score: )\d+" {} \; | head -1 || echo 0)
          echo "Previous Mutation Score: $PREV_SCORE"
          echo "Current Mutation Score: $CURR_SCORE"
          if [ "$CURR_SCORE" -lt "$PREV_SCORE" ]; then
            exit 1
          fi
  rickroll:
    needs: build
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Rickroll on failure
        run: |
          echo "Le score de mutation a baissé !!"
          echo "Never gonna give you up"
          echo "Never gonna let you down"
          echo "Never gonna fail the tests and desert you"
          echo "Never gonna make you cry"
          echo "Never gonna say 'Good try'"
          echo "Never gonna tell a lie and compile for you"
